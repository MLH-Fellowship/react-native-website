---
id: profile-hermes
title: Profiling with Hermes
---

You can visualize JavaScript's performance in a React Native app using [Hermes](https://github.com/facebook/hermes). Hermes is a small and lightweight JavaScript engine optimized for running React Native on Android (you can [read more about using it with React Native here](hermes). Hermes helps improve app performance and also exposes ways to analyze the performance of the JavaScript that it runs.

This section contains directions on how to profile your React Native app running on Hermes. You will be able to visualize the profile using [the Performance tab on Chrome DevTools](https://developers.google.com/web/tools/chrome-devtools/evaluate-performance/reference)

> Be sure to [enable hermes in your app](hermes) before you get started!

Follow the instructions below to get started profiling:

1 [Record a Hermes sampling profile](profile-hermes.md#record-a-hermes-sampling-profile)
2 [Execute command from CLI](profile-hermes.md#execute-command-from-cli)
3 [Open the downloaded profile on Chrome DevTools](profile-hermes.md#open-the-downloaded-profile-on-chrome-devtools)

## Record a Hermes sampling profile

Record a sampling profiler from the Developer Menu:

1 Open Developer Menu with `Cmd+M` or Shake the device. Select `Enable Sampling Profiler`
2 Execute JavaScript by using the app (pressing buttons, etc.)
3 Open Developer Menu again, select `Disable Sampling Profiler`. A toast shows the location where the sampling profiler is saved, usually in `/data/user/0/com.appName/cache/*.cpuprofile`

<img src="/docs/assets/HermesProfileSaved.png" height=465 width=250 alt="Toast Notification of Profile saving">

## Execute command from CLI

You can use the [React Native CLI](https://github.com/react-native-community/cli) to convert the Hermes tracing profile to Chrome tracing profile, and then pull it to your local machine using:

```sh
react-native profile-hermes [destinationDir]
```

### Notes on source map

- Source map is used to enhance the profile and associate trace events with the application code
- This step is recommended in order for the source map to be generated automatically for the use of the above command:

#### Enable `bundleInDebug: true` if the app is running in development mode:

This allows React Native to build the bundle during its running process

- In the `android/app/build.gradle` file of the React Native app that you use to test, add

```java
project.ext.react = [
  bundleInDebug: true,
]
```

- Clean the build by running this command

```sh
cd android && ./gradlew clean
```

- Run your app as usual

```sh
npx react-native run-android
```

### Common errors encountered during the process

#### `adb: no devices/emulators found` or `adb: device offline`

- Cause: The CLI cannot access the device or emulator (through adb) you are using to run the app
- Solution: make sure your Android device/ emulator is connected and running. The command only works when it can access adb

#### `There is no file in the cache/ directory`

- Cause: cannot find any **.cpuprofile** file in your app's **cache/** directory. You might have forgotten to record a profile from the device
- Solution: instruction on how to enable/ disable profiler from device is [above](profile-hermes.md#recording-a-hermes-sampling-profile)

#### `Error: your_profile_name.cpuprofile is an empty file`

- Cause: the profile is empty, it might be because Hermes is not running correctly or crashes
- Solution: make sure your app is running with Hermes and update Hermes to the latest version

## Open the downloaded profile on Chrome DevTools

You can load the downloaded profile in the Chrome DevTools by doing the following:

1.  Open Developer Tools in Chrome
2.  Navigate to the `Performance` tab
3.  Use `Load profile...` button

 <img src="/docs/assets/openChromeProfile.png" alt="Loading a performance profile on Chrome DevTools">

## How does the Hermes Profile Transformer work?

The Hermes Sample Profile generated by following the steps listed above is of the `JSON object format`, while the format that Google's DevTools supports is predominantly `JSON Array Format`. (More information about the formats can be found on the [Trace Event Format Document](https://docs.google.com/document/d/1CvAClvFfyA5R-PhYUmn5OOQtYMH4h6I0nSsKchNAySU/preview))

```ts
export interface HermesCPUProfile {
  traceEvents: SharedEventProperties[];
  samples: HermesSample[];
  stackFrames: { [key in string]: HermesStackFrame };
}
```

The Hermes Profile generated has most of its information encoded into the `samples` and `stackFrames` properties. Each sample is a snapshot of the function call stack at that particular timestamp as each sample has a `sf` property which corresponds to a function call.

```ts
export interface HermesSample {
  cpu: string;
  name: string;
  ts: string;
  pid: number;
  tid: string;
  weight: string;
  /**
   * Will refer to an element in the stackFrames object of the Hermes Profile
   */
  sf: number;
  stackFrameData?: HermesStackFrame;
}
```

The information about a function call can be found in `stackFrames` which contains key-object pairs, where the key is the `sf` number and the object corresponding to the key gives us all the relevant information about the function including the `sf` number of its parent function. This parent-child relationship can be traced upwards to find the information about all the functions running at a particular instant.

```ts
export interface HermesStackFrame {
  line: string;
  column: string;
  funcLine: string;
  funcColumn: string;
  name: string;
  category: string;
  /**
   * A parent function may or may not exist
   */
  parent?: number;
}
```

At this point in time, we should also define a few more terms, namely:

1. Nodes: The objects corresponding to `sf` numbers in `stackFrames` are called nodes
2. Active Nodes: The nodes which are currently running at a particular point of time. We can classify a node as running if its `sf` number is in the function call stack, which can be obtained from the `sf` number of the sample and tracing upwards till parent `sf`s are available

The `samples` and the `stackFrames` in tandem can hence be used to generate all the start and end events at the corresponding sampling timestamps, wherein -

1. Start Nodes/Events - Nodes absent in the previous sample's function call stack but present in the current sample's function call stack.
2. End Nodes/Events - Nodes present in the previous sample's function call stack but absent in the current sample's function call stack.

<img src="/docs/assets/CallStackDemo.jpg" height=400 width=300 alt="CallStack Terms Explained">

Using this information, we can construct a `flamechart` of function calls as we essentially have all the function information including its start and end timestamps.

The `hermes-profile-transformer` can convert any profile generated using Hermes into a format that can be directly displayed in DevTools. More information about this can be found on [ `@react-native-community/hermes-profile-transformer` ](https://github.com/react-native-community/hermes-profile-transformer)
